<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>StoryCraft Editor â€” All-in-One</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,'Noto Sans KR',sans-serif;background:#fafbff;margin:0}
    header{position:sticky;top:0;background:#fff;padding:10px 12px;border-bottom:1px solid #e7e7f3;z-index:10}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar select,.toolbar button,.toolbar input[type="file"]{border:1px solid #c7c7e6;border-radius:10px;padding:8px 10px;background:linear-gradient(180deg,#fff,#f6f6ff)}
    .toolbar button{cursor:pointer;box-shadow:0 4px 10px rgba(120,120,200,.15)}
    .toolbar button.primary{background:linear-gradient(135deg,#a3b8ff,#e1b2ff);color:#132045;font-weight:700}
    .wrap{max-width:1000px;margin:18px auto;padding:0 16px}
    #doc{min-height:380px;background:#f1eeff3a;border:2px solid #9aa5ff;border-radius:14px;padding:18px;line-height:1.7;outline:none;white-space:pre-wrap}
    #status{font-size:13px;color:#586;}
    .two-col{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    .panel{background:#fff;border:1px solid #e7e7f3;border-radius:14px;padding:12px}
    .panel h3{margin:0 0 8px 0;font-size:16px}
    table.grammar{width:100%;border-collapse:collapse}
    table.grammar th,table.grammar td{border:1px solid #deddf5;padding:8px;vertical-align:top}
    table.grammar th{background:#5c62d8;color:#fff}
    td.right{white-space:pre-wrap}
    .muted{opacity:.7}
    .hidden{display:none}
    .spinner{display:none;margin-left:6px}
  </style>
  <!-- (ì„ íƒ) ë°°í¬/ë¡œì»¬ ê°•ì œ ì˜¤ë²„ë¼ì´ë“œ: í•„ìš”ì‹œ ì£¼ì„ í•´ì œ -->
  <!-- <script>window.BASE_URL_OVERRIDE='https://storycraft-ppxj.onrender.com';</script> -->
</head>
<body>
<header>
  <div class="toolbar wrap">
    <span class="muted">ì›ë³¸:</span>
    <select id="srcLang">
      <option value="auto" selected>ìë™ ê°ì§€</option>
      <option value="ko">í•œêµ­ì–´</option><option value="en">ì˜ì–´</option><option value="ja">ì¼ë³¸ì–´</option>
      <option value="zh">ì¤‘êµ­ì–´</option><option value="es">ìŠ¤í˜ì¸ì–´</option>
    </select>
    <span class="muted">â†’ ëŒ€ìƒ:</span>
    <select id="tgtLang">
      <option value="ko">í•œêµ­ì–´</option><option value="en" selected>ì˜ì–´</option>
      <option value="ja">ì¼ë³¸ì–´</option><option value="zh">ì¤‘êµ­ì–´</option><option value="es">ìŠ¤í˜ì¸ì–´</option>
    </select>
    <button id="btnTranslate" class="primary">ë²ˆì—­ ğŸŒ</button>

    <select id="styleSelect" title="ë¬¸ì²´ ë³€ê²½">
      <option value="formal">ê²©ì‹ì²´</option>
      <option value="casual">ìºì£¼ì–¼</option>
      <option value="academic">í•™ìˆ ì²´</option>
      <option value="press">ë³´ë„ìë£Œì²´</option>
    </select>
    <button id="btnStyle">ë¬¸ì²´ ë³€ê²½ âœ’ï¸</button>
    <button id="btnRewrite">ì²¨ì‚­ âœï¸</button>
    <button id="btnSummary">ìš”ì•½ ğŸ§©</button>
    <button id="btnExpand">í™•ì¥ â•</button>
    <button id="btnHonor">ê²½ì–´ì²´ ğŸ™‡</button>
    <button id="btnInformal">í‰ì–´ì²´ ğŸ™‚</button>
    <button id="btnGrammar">ë¬¸ë²• êµì • âœ…</button>

    <label class="muted" style="margin-left:6px">ì‚½ì…:</label>
    <input type="file" id="imgPicker" accept="image/*" />
    <button id="btnOCR">ì´ë¯¸ì§€ ìŠ¤ìº” ì‚½ì…</button>
    <input type="file" id="pdfPicker" accept="application/pdf" />
    <button id="btnPDFScan">PDF ìŠ¤ìº” ì‚½ì…</button>

    <button id="btnSavePdf" class="primary" style="margin-left:auto">ë¬¸ì„œ PDF ì €ì¥</button>
    <span id="status" class="spinner">â³ ì²˜ë¦¬ ì¤‘â€¦</span>
  </div>
</header>

<div class="wrap two-col">
  <div class="panel">
    <h3>ë¬¸ì„œ</h3>
    <div id="doc" contenteditable="true" spellcheck="false" placeholder="ì—¬ê¸°ì— ê¸€ì„ ì…ë ¥í•˜ê±°ë‚˜, PDF/ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ìŠ¤ìº”í•´ ì‚½ì…í•˜ì„¸ìš”."></div>
  </div>

  <div class="panel">
    <h3 style="display:flex;justify-content:space-between;align-items:center">
      ë¬¸ë²• êµì • í‘œ
      <button id="btnApplyCorrections" class="hidden">êµì • ì ìš©</button>
    </h3>
    <table class="grammar" id="grammarTable">
      <thead><tr><th>êµì •ë¬¸</th><th>ê´€ë ¨ ê·œë²”Â·ì„¤ëª…</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="muted" style="margin-top:8px">ì„ íƒ ë¬¸ë‹¨ë§Œ êµì •í•˜ë ¤ë©´ ì—ë””í„°ì—ì„œ ë¬¸ì¥ì„ ì„ íƒí•œ ë’¤ â€œë¬¸ë²• êµì •â€ì„ ëˆ„ë¥´ì„¸ìš”.</div>
  </div>
</div>

<!-- html2pdf (ë¡œì»¬ì— ì´ë¯¸ ì“°ëŠ” ë²„ì „ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©) -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<script>
/* ========= í™˜ê²½ & ìœ í‹¸ ========= */
const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
const BASE_URL = (window.BASE_URL_OVERRIDE && String(window.BASE_URL_OVERRIDE)) ||
                 (isLocalhost ? 'http://127.0.0.1:8000' : 'https://storycraft-ppxj.onrender.com');

function $(sel){ return document.querySelector(sel); }
function getSelectedText(){
  const sel = window.getSelection();
  return sel && sel.toString() ? sel.toString() : '';
}
function replaceSelection(text){
  const sel = window.getSelection();
  if (!sel || !sel.rangeCount) { $('#doc').textContent = text; return; }
  const range = sel.getRangeAt(0);
  range.deleteContents();
  range.insertNode(document.createTextNode(text));
  // ì»¤ì„œ ëìœ¼ë¡œ ì´ë™
  range.collapse(false);
  sel.removeAllRanges(); sel.addRange(range);
}
function getScopeText(){
  const t = getSelectedText();
  return t && t.trim() ? t : $('#doc').innerText;
}
function setBusy(on){ $('#status').style.display = on ? 'inline' : 'none'; toolbarDisable(on); }
function toolbarDisable(dis){
  document.querySelectorAll('button,select,input[type="file"]').forEach(el=>{ el.disabled = dis; });
}
async function fetchWithRetry(url,opts={},retries=2,delay=1200){
  try{
    const r = await fetch(url,opts);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r;
  }catch(e){
    if(retries<=0) throw e;
    await new Promise(r=>setTimeout(r,delay));
    return fetchWithRetry(url,opts,retries-1,Math.round(delay*1.6));
  }
}
function cutLong(text,max=8000){ return text.length>max ? text.slice(0,max) : text; }

/* ========= ê³µí†µ ì²˜ë¦¬ ========= */
async function callJSON(endpoint, payload){
  // ì½œë“œìŠ¤íƒ€íŠ¸ ì›œì—…
  fetch(BASE_URL+'/whoami',{cache:'no-store'}).catch(()=>{});
  return fetchWithRetry(BASE_URL+'/'+endpoint,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  });
}

/* ========= ë™ì‘ í•¸ë“¤ëŸ¬ ========= */
async function doTranslate(){
  const src = $('#srcLang').value; const tgt = $('#tgtLang').value;
  let content = getScopeText().trim(); if(!content) return alert('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
  content = cutLong(content);
  setBusy(true);
  try{
    const res = await callJSON('translate',{ text: content, source: src, target: tgt });
    const data = await res.json();
    const out = (data.result||data.text||'').toString();
    replaceSelection(out || '[ë²ˆì—­ ê²°ê³¼ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤]');
  }catch(e){ alert('ë²ˆì—­ ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

async function doRewrite(){
  let content = getScopeText().trim(); if(!content) return alert('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
  content = cutLong(content);
  setBusy(true);
  try{
    const res = await callJSON('mistralRewrite',{ content });
    const data = await res.json();
    const out = (data.result||'').toString();
    replaceSelection(out || '[ì²¨ì‚­ ê²°ê³¼ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤]');
  }catch(e){ alert('ì²¨ì‚­ ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

async function doStyleChange(){
  let content = getScopeText().trim(); if(!content) return alert('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
  content = cutLong(content);
  const style = $('#styleSelect').value;
  setBusy(true);
  try{
    const res = await callJSON('gptStyleChange',{ text: content, style });
    const data = await res.json();
    replaceSelection((data.result||'').toString() || '[ë¬¸ì²´ë³€ê²½ ê²°ê³¼ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤]');
  }catch(e){ alert('ë¬¸ì²´ ë³€ê²½ ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

async function doSummary(){
  let content = getScopeText().trim(); if(!content) return alert('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
  content = cutLong(content);
  setBusy(true);
  try{
    const res = await callJSON('summary',{ content });
    const data = await res.json();
    replaceSelection((data.result||'').toString() || '[ìš”ì•½ ê²°ê³¼ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤]');
  }catch(e){ alert('ìš”ì•½ ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

async function doExpand(){
  let content = getScopeText().trim(); if(!content) return alert('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
  content = cutLong(content);
  setBusy(true);
  try{
    const res = await callJSON('expand',{ content });
    const data = await res.json();
    replaceSelection((data.result||'').toString() || '[í™•ì¥ ê²°ê³¼ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤]');
  }catch(e){ alert('í™•ì¥ ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

async function doHonorific(){
  let content = getScopeText().trim(); if(!content) return alert('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
  content = cutLong(content);
  setBusy(true);
  try{
    const res = await callJSON('cohereHonorific',{ content });
    const data = await res.json();
    replaceSelection((data.result||'').toString() || '[ê²½ì–´ ë³€í™˜ ê²°ê³¼ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤]');
  }catch(e){ alert('ê²½ì–´ ë³€í™˜ ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

async function doInformal(){
  let content = getScopeText().trim(); if(!content) return alert('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
  content = cutLong(content);
  setBusy(true);
  try{
    const res = await callJSON('cohereInformal',{ content });
    const data = await res.json();
    replaceSelection((data.result||'').toString() || '[í‰ì–´ ë³€í™˜ ê²°ê³¼ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤]');
  }catch(e){ alert('í‰ì–´ ë³€í™˜ ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

async function doGrammar(){
  const tbody = $('#grammarTable tbody');
  tbody.innerHTML = '';
  let content = getScopeText().trim(); if(!content) return alert('í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
  content = cutLong(content);
  setBusy(true);
  try{
    const res = await callJSON('mistralGrammar',{ content });
    const data = await res.json();
    const raw = (data.result||'').toString();

    // íŒŒì‹±í•˜ì—¬ í‘œ ì±„ìš°ê¸°
    const lines = raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const strip = s => s.replace(/^[^\wê°€-í£]+/,'').trim();
    const corrected = [];
    for(let i=0;i<lines.length;i+=4){
      const from = strip(lines[i]||''); const to = strip(lines[i+1]||'');
      const rule1 = lines[i+2]||''; const rule2 = lines[i+3]||'';
      if(!from && !to) continue;
      if(from===to) continue;
      corrected.push(to);
      const tr = document.createElement('tr');
      const tdL = document.createElement('td'); const tdR = document.createElement('td'); tdR.className='right';
      tdL.innerText = `âŒ ${from}\nâœ… ${to}`;
      tdR.textContent = `${rule1}\n${rule2}`;
      tbody.appendChild(tr); tr.appendChild(tdL); tr.appendChild(tdR);
    }

    // êµì • ì ìš© ë²„íŠ¼ í‘œì‹œ/ë™ì‘
    const btnApply = $('#btnApplyCorrections');
    if (corrected.length){
      btnApply.classList.remove('hidden');
      btnApply.onclick = ()=>{
        replaceSelection(corrected.join('\n'));
        btnApply.classList.add('hidden');
      };
    } else {
      btnApply.classList.add('hidden');
      alert('í‹€ë¦° ë¶€ë¶„ì´ ì—†ê±°ë‚˜ êµì • ê²°ê³¼ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.');
    }
  }catch(e){ alert('ë¬¸ë²• êµì • ì‹¤íŒ¨: '+e); }
  finally{ setBusy(false); }
}

/* ========= OCR / PDF ìŠ¤ìº” ì‚½ì… ========= */
async function insertFromImage(){
  const f = $('#imgPicker').files[0];
  if(!f) return alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
  const fd = new FormData(); fd.append('image', f);
  setBusy(true);
  try{
    const res = await fetchWithRetry(BASE_URL+'/visionOCR',{ method:'POST', body:fd });
    const js = await res.json();
    const txt = (js.result||js.text||'').toString().replace(/\u00A0/g,' ').trim();
    replaceSelection(txt || '[í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤]');
    $('#imgPicker').value='';
  }catch(e){ alert('ì´ë¯¸ì§€ ìŠ¤ìº” ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

async function insertFromPDF(){
  const f = $('#pdfPicker').files[0];
  if(!f) return alert('PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
  const fd = new FormData(); fd.append('pdf', f);
  setBusy(true);
  try{
    const res = await fetchWithRetry(BASE_URL+'/pdfScan',{ method:'POST', body:fd });
    const js = await res.json();
    const txt = (js.text||'').toString().replace(/\u00A0/g,' ').trim();
    replaceSelection(txt || '[í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤]');
    $('#pdfPicker').value='';
  }catch(e){ alert('PDF ìŠ¤ìº” ì‹¤íŒ¨: '+e); } finally{ setBusy(false); }
}

/* ========= PDF ì €ì¥ ========= */
function saveDocAsPDF(){
  const opt = { margin:10, filename:'StoryCraft-ë¬¸ì„œ.pdf',
    html2canvas:{ scale:2, useCORS:true }, jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' } };
  html2pdf().from($('#doc')).set(opt).save();
}

/* ========= ì´ë²¤íŠ¸ ë°”ì¸ë”© ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // ì›œì—…(ì½œë“œìŠ¤íƒ€íŠ¸ ì™„í™”)
  fetch(BASE_URL+'/whoami',{cache:'no-store'}).catch(()=>{});
  setTimeout(()=>fetch(BASE_URL+'/whoami',{cache:'no-store'}).catch(()=>{}), 2500);

  $('#btnTranslate').onclick = doTranslate;
  $('#btnRewrite').onclick   = doRewrite;
  $('#btnStyle').onclick     = doStyleChange;
  $('#btnSummary').onclick   = doSummary;
  $('#btnExpand').onclick    = doExpand;
  $('#btnHonor').onclick     = doHonorific;
  $('#btnInformal').onclick  = doInformal;
  $('#btnGrammar').onclick   = doGrammar;

  $('#btnOCR').onclick       = insertFromImage;
  $('#btnPDFScan').onclick   = insertFromPDF;

  $('#btnSavePdf').onclick   = saveDocAsPDF;
});
</script>
</body>
</html>
