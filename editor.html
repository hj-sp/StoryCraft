<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <title>StoryCraft Editor</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta name="description" content="" />
        <meta name="keywords" content="" />

        <!-- Favicons -->
        <link href="assets/img/favicon.png" rel="icon" />
        <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

        <!-- Fonts -->
        <link href="https://fonts.googleapis.com" rel="preconnect" />
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
            rel="stylesheet"
        />

        <!-- Vendor CSS Files -->
        <link
            href="assets/vendor/bootstrap/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
            rel="stylesheet"
        />
        <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
        <link
            href="assets/vendor/glightbox/css/glightbox.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/swiper/swiper-bundle.min.css"
            rel="stylesheet"
        />
        <!-- Quill -->
        <link
            href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css"
            rel="stylesheet"
        />

        <!-- Main CSS File -->
        <link href="assets/css/main.css" rel="stylesheet" />
  
    </head>
    <body class="index-page page-editor">
        <header id="header" class="header d-flex align-items-center sticky-top">
            <div
                class="container position-relative d-flex align-items-center justify-content-between"
            >
                <a
                    href="index.html"
                    class="logo d-flex align-items-center me-auto me-xl-0"
                >
                    <!-- Uncomment the line below if you also wish to use an image logo -->
                    <!-- <img src="assets/img/logo.png" alt=""> -->
                    <h1 class="sitename">StoryCraft</h1>
                </a>

                <nav id="navmenu" class="navmenu">
                    <ul>
                        <!-- <li>
                            <a href="index.html#hero" class="active">Home</a>
                        </li>
                        <li><a href="index.html#about">About</a></li>
                        <li><a href="index.html#services">Services</a></li> -->
                        <li><a href="search.html">Search</a></li>
                        <li><a href="rewrite.html">Rewrite</a></li>
                        <li><a href="change-style.html">Style</a></li>
                        <li><a href="grammar.html">Grammar</a></li>
                        <li><a href="honorific.html">Honorific</a></li>
                        <li><a href="translate.html">Translate</a></li>
                        <li><a href="scan.html">Scan</a></li>
                        <li><a href="image.html">Image Scan</a></li>
                        <li><a href="speech.html">Speech</a></li>
                        <li><a href="editor.html" class="active">Editor</a></li>
                    </ul>
                    <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
                </nav>
            </div>
        </header>
        
        <div class="wrap">
        <!-- 에디터 카드 -->
            <div class="card editor-card">
                <div class="ql-frame">
                <div class="toolbar">
                    <div id="quill-toolbar">
                        <span class="ql-formats">
                            <select class="ql-header">
                                <option value="1"></option>
                                <option value="2"></option>
                                <option selected></option>
                            </select>
                            <select class="ql-font">
  <option value="malgun" selected></option>
  <option value="serif"></option>
  <option value="monospace"></option>
  <option value="batang"></option>
  <option value="gungsuh"></option>
  <option value="gulim"></option>
  <option value="noto-sans-kr"></option>
</select>

                            <select class="ql-size"></select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                            <button class="ql-strike"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                            <select class="ql-align"></select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-link"></button>
                            <button class="ql-blockquote"></button>
                            <button class="ql-code-block"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-clean"></button>

                             <button type="button" id="btn-image" class="btn-image" title="이미지">
                                <i class="bi bi-image"></i>
                            </button>
                        </span>

                        <span class="ql-formats edit-upload">
  <input id="ocrFile" type="file" accept="image/*,application/pdf" hidden>
  <label for="ocrFile" class="edit-upload__btn" title="파일 업로드" aria-label="파일 업로드">
    <i class="bi bi-folder-fill"></i><span class="edit-upload__text">파일 업로드</span>
  </label>
  <span id="ocrFileName" class="edit-upload__name" hidden></span>
</span>
                    </div>
                </div>
                <div id="quill" class="editor"></div>
                </div>
                
               

                <textarea id="userInput" style="display: none"></textarea>
                <input id="styleInput" type="hidden" />
                <input id="translateInput" type="hidden" />
            </div>

            <!-- 사이드 툴 패널 -->
            <div class="card side">
                <section class="panel">
                    <div class="panel-title">Translate & Import</div>
                    <div class="grid-2" style="margin-bottom: 8px">
                        <select
                            id="sourceSelector"
                            class="sc-select"
                            title="원본 언어"
                        >
                            <option value="auto" selected>자동 감지</option>
                            <option value="gu">구자라트어</option>
                            <option value="el">그리스어</option>
                            <option value="ne">네팔어</option>
                            <option value="nl">네덜란드어</option>
                            <option value="de">독일어</option>
                            <option value="ru">러시아어</option>
                            <option value="ro">루마니아어</option>
                            <option value="mr">마라티어</option>
                            <option value="ms">말레이어</option>
                            <option value="vi">베트남어</option>
                            <option value="bn">벵골어</option>
                            <option value="sv">스웨덴어</option>
                            <option value="es">스페인어</option>
                            <option value="af">아프리칸스어</option>
                            <option value="ar">아랍어</option>
                            <option value="en">영어</option>
                            <option value="uk">우크라이나어</option>
                            <option value="it">이탈리아어</option>
                            <option value="ja">일본어</option>
                            <option value="jv">자바어</option>
                            <option value="ka">조지아어</option>
                            <option value="zh-CN">중국어(간체)</option>
                            <option value="zh-TW">중국어(번체)</option>
                            <option value="ta">타밀어</option>
                            <option value="th">태국어</option>
                            <option value="tr">터키어</option>
                            <option value="fa">페르시아어</option>
                            <option value="pt">포르투갈어</option>
                            <option value="pl">폴란드어</option>
                            <option value="fr">프랑스어</option>
                            <option value="ko">한국어</option>
                            <option value="hi">힌디어</option>
                        </select>

                        <!-- 대상 언어 선택 -->
                        <select
                            id="targetSelector"
                            class="sc-select"
                            title="대상 언어"
                        >
                            <option value="gu">구자라트어</option>
                            <option value="el">그리스어</option>
                            <option value="ne">네팔어</option>
                            <option value="nl">네덜란드어</option>
                            <option value="de">독일어</option>
                            <option value="ru">러시아어</option>
                            <option value="ro">루마니아어</option>
                            <option value="mr">마라티어</option>
                            <option value="ms">말레이어</option>
                            <option value="vi">베트남어</option>
                            <option value="bn">벵골어</option>
                            <option value="sv">스웨덴어</option>
                            <option value="es">스페인어</option>
                            <option value="af">아프리칸스어</option>
                            <option value="ar">아랍어</option>
                            <option value="en" selected>영어</option>
                            <option value="uk">우크라이나어</option>
                            <option value="it">이탈리아어</option>
                            <option value="ja">일본어</option>
                            <option value="jv">자바어</option>
                            <option value="ka">조지아어</option>
                            <option value="zh-CN">중국어(간체)</option>
                            <option value="zh-TW">중국어(번체)</option>
                            <option value="ta">타밀어</option>
                            <option value="th">태국어</option>
                            <option value="tr">터키어</option>
                            <option value="fa">페르시아어</option>
                            <option value="pt">포르투갈어</option>
                            <option value="pl">폴란드어</option>
                            <option value="fr">프랑스어</option>
                            <option value="ko">한국어</option>
                            <option value="hi">힌디어</option>
                        </select>
                    </div>

                    <div class="grid-1">
                        <button
                            class="sc-btn sc-btn--primary"
                            id="btn-translate"
                        >
                            🌐 번역
                        </button>
                    </div>
                </section>

                <div class="hr"></div>

                <!-- 문체변경 -->
                <section class="panel">
                    <div class="panel-title">Style & Tone</div>
                    <div class="grid-2" style="margin-bottom: 8px">
                        <select
                            id="styleSelector"
                            class="sc-select"
                            title="문체 선택"
                        >
                            <option value="casual">구어체</option>
                            <option value="formal">격식체</option>
                            <option value="literary">문학체</option>
                            <option value="academic">학술체</option>
                        </select>
                        <button
                            class="sc-btn sc-btn--primary"
                            id="btn-style"
                            onclick="applyStyle()"
                        >
                            ✒️ 문체변경
                        </button>
                    </div>

                    <div class="grid-2">
                        <button class="sc-btn sc-btn--honorific" id="btn-honorific">🙇 높임말</button>

                        <button class="sc-btn sc-btn--informal" id="btn-informal">
                            🙂 반말
                        </button>
                    </div>
                </section>

                <div class="hr"></div>

                <!-- 첨삭/요약/확장 -->
                <section class="panel">
                    <div class="panel-title">Rewrite & Summary</div>
                    <div class="grid-2" style="margin-bottom: 8px">
                        <button
                            class="sc-btn sc-btn--summary"
                            id="btn-summary"
                        >
                            🧾 요약
                        </button>

                        <button class="sc-btn sc-btn--expand" id="btn-expand">➕ 확장</button>
                        
                    </div>
                    <div class="grid-1">
                        <button class="sc-btn sc-btn--primary"
                     id="btn-rewrite">🛠️ 첨삭</button>

                    </div>
                </section>
                <!-- 문법 교정 -->
                <section class="panel">
                    <div class="panel-title">Grammar</div>
                    <div class="grid-1">
                        <button
                            class="sc-btn sc-btn--primary"
                            id="btn-grammar"
                        >
                            ✔️ 문법 교정
                        </button>
                    </div>
                </section>

                <section class="panel sticky">
                    <div class="panel-title">Export</div>
                    <div class="grid-1">
                        <button
                            class="sc-btn sc-btn--secondary"
                            id="pdfDownloadBtn"
                        >
                            ⬇️ PDF로 저장
                        </button>
                    </div>
                </section>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
        <script>
  (function(){
    const input = document.getElementById('ocrFile');
    const nameEl = document.getElementById('ocrFileName');
    if (!input || !nameEl) return;
    input.addEventListener('change', function(){
      const file = this.files && this.files[0];
      if (file){
        nameEl.textContent = file.name;
        nameEl.hidden = false;
      }else{
        nameEl.textContent = '';
        nameEl.hidden = true;

    
      }
    });
  })();
</script>

        <script>
           
            const PROD_API = 'https://storycraft-ppxj.onrender.com'; 
            const LOCAL_API = 'http://127.0.0.1:8000'; 

            const isLocalHost =
            location.hostname === 'localhost' ||
            location.hostname.startsWith('127.') ||
            location.hostname.endsWith('.local');

            const BASE_URL = isLocalHost ? LOCAL_API : PROD_API;
            window.BASE_URL = BASE_URL;
            window.API_BASE_URL = BASE_URL;
            const $editSpinner = document.getElementById('edit_spinner');

            const Font = Quill.import('formats/font');
            Font.whitelist = [
            'malgun','batang','gungsuh','gulim','noto-sans-kr', 'sans-serif','serif','monospace'
            ];

            const SizeStyle = Quill.import('attributors/style/size');
            SizeStyle.whitelist = [
  '13.3px', // 10pt
  '14.7px', // 11pt
  '16px',   // 12pt
  '18.7px', // 14pt
  '21.3px', // 16pt
  '24px',   // 18pt
  '32px'    // 24pt
];
            Quill.register(SizeStyle, true);
            Quill.register(Font, true);

            function injectSizePresetBeforeInit(){
                const sel = document.querySelector('#quill-toolbar .ql-size');
                if (!sel) return;
                sel.id = 'sizePreset';
                if (!sel.options.length) {
                    sel.innerHTML = `
  <option value="13.3px">10</option>
  <option value="14.7px">11</option>
  <option value="16px"   selected>12</option>
  <option value="18.7px">14</option>
  <option value="21.3px">16</option>
  <option value="24px">18</option>
  <option value="32px">24</option>
`;

    }
        }

            injectSizePresetBeforeInit();

            

            const quill = new Quill('#quill', {
                modules: { toolbar: '#quill-toolbar' },
                theme: 'snow',
                placeholder: '여기에 문서를 작성하세요…',
            });
             window.quill = quill;
            
const toolbarMod = quill.getModule('toolbar');

let __sizeRange = null;
const toolbarEl = document.getElementById('quill-toolbar');
const captureRange = () => { __sizeRange = quill.getSelection(true); };
toolbarEl?.querySelector('.ql-picker.ql-size')?.addEventListener('mousedown', captureRange);
document.getElementById('sizePreset')?.addEventListener('mousedown', captureRange);
toolbarEl?.querySelector('.ql-picker.ql-size')?.addEventListener('touchstart', captureRange, {passive:true});

toolbarMod.addHandler('size', (value) => {
  // value가 이제 '16px' 같은 px 문자열
  if (!value) { quill.format('size', false); return; }

  const range = __sizeRange || quill.getSelection();
  if (range && range.length > 0) {
    quill.formatText(range.index, range.length, 'size', value, 'user');
    quill.setSelection(range.index, range.length, 'silent');
  } else {
    quill.format('size', value);
  }
  __sizeRange = null;
});

            quill.setSelection(0, 0, 'silent');
            quill.format('font', 'malgun', 'silent');

            const fontSel = document.querySelector('.ql-font');
            if (fontSel) fontSel.value = 'malgun';

            
            function setEditorText(text) {
                
                quill.setText(text || '');
            }
            function getEditorText() {
                return quill.getText(); 
            }

            
            function showSpin(v) {
                
                document.documentElement.classList.toggle('is-edit-loading', !!v);

                const el = document.getElementById('edit_spinner');
                if (el) el.setAttribute('aria-hidden', String(!v));
    }


function getQuillSelectionOrAll() {

  const sel = quill.getSelection(true);
  if (sel && sel.length > 0) {
    const text = quill.getText(sel.index, sel.length);
    return {
      text,
      isAll: false,
      apply(out) {
        const attrs = quill.getFormat(sel.index, Math.max(sel.length, 1));
        quill.deleteText(sel.index, sel.length, 'user');
        quill.insertText(sel.index, out, attrs, 'user');
        quill.setSelection(sel.index + out.length, 0, 'silent');
      },
    };
  }

  const len = quill.getLength();
  const text = quill.getText(0, len);
  return {
    text,
    isAll: true,
    apply(out) { quill.setText(out); },
  };
}


['btn-rewrite','btn-summary','btn-expand','btn-style','btn-honorific','btn-informal','btn-translate','btn-grammar']
  .forEach(id=>{
    const b=document.getElementById(id);
    if(!b) return;
    b.addEventListener('mousedown', ()=>{ window.__lastQuillRange = quill.getSelection(true); });
  });
quill.on('selection-change', (range)=>{ window.__lastQuillRange = range; });


            async function postJSON(url, payload) {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(`HTTP ${res.status} - ${t}`);
                }
                return res.json();
            }

           
            async function doRewrite() {
  const { text, apply } = getQuillSelectionOrAll();
  const content = (text || '').trim();
  if (!content) { alert('내용을 입력하세요.'); return; }

  showSpin(true);
  try {
    const data = await postJSON(`${BASE_URL}/mistralRewrite`, { content });
    const out =
      (data?.result ?? data?.text ?? data?.styled_text ?? data?.checked ?? data?.translated ?? '').trim();
    if (!out) throw new Error('빈 결과');
    
    apply(out);
  } catch (e) {
    alert('첨삭 실패: ' + e.message);
  } finally {
    showSpin(false);
  }
}

            async function doSummary() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('내용을 입력하세요.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/summary`, {
                        content,
                    }); 
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('빈 결과');
                    apply(out);
                } catch (e) {
                    alert('요약 실패: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doExpand() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('내용을 입력하세요.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/expand`, {
                        content,
                    }); // 확장 엔드포인트로 변경
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('빈 결과');
                    apply(out);
                } catch (e) {
                    alert('확장 실패: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doStyle() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                const style = document.getElementById('styleSelector').value;

                if (!content) {
                    alert('내용을 입력하세요.');
                    return;
                }
                showSpin(true);

                try {
                    const data = await postJSON(`${BASE_URL}/gptStyleChange`, {
                        text: content,
                        style: style,
                    }); 
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('빈 결과');
                    apply(out);
                } catch (e) {
                    alert('문체변경 실패: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doHonorific() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('내용을 입력하세요.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/cohereHonorific`, {
                        content,
                    });
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('빈 결과');
                    apply(out);
                } catch (e) {
                    alert('높임말 변환 실패: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doInformal() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('내용을 입력하세요.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/cohereInformal`, {
                        content,
                    });
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('빈 결과');
                    apply(out);
                } catch (e) {
                    alert('반말 변환 실패: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doTranslate() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('내용을 입력하세요.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/translate`, {
                        text: content,
                        source: 'auto',
                        target: 'en',
                    });
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('빈 결과');
                    apply(out);
                } catch (e) {
                    alert('번역 실패: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doOCRorFile() {
                
                const file = document.getElementById('ocrFile').files[0];
                if (!file) {
                    alert('파일을 선택하세요.');
                    return;
                }

                const form = new FormData();
                
                if (/\.(png|jpg|jpeg|bmp|tif|tiff)$/i.test(file.name)) {
                    form.append('image', file);
                    await uploadTo(`${BASE_URL}/visionOCR`, form, 'text');
                } else {
                    form.append('file', file);
                    await uploadTo(`${BASE_URL}/fileScan`, form, 'text');
                }
            }
            async function doGrammar() {
  const { text, apply } = getQuillSelectionOrAll();
  const content = (text || '').trim();
  if (!content) { alert('선택(또는 전체) 내용이 비어 있어요.'); return; }

  showSpin(true);
  try {
    const data = await postJSON(`${BASE_URL}/editorGrammar`, { content });
  
    const out = (data?.checked ?? data?.result ?? data?.text ?? '').trim();
    if (!out) throw new Error('빈 결과');


    apply(out);
  } catch (e) {
    alert('문법 교정 실패: ' + e.message);
  } finally {
    showSpin(false);
  }
}
            async function uploadTo(url, form, expectField = 'text') {
                showSpin(true);
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        body: form,
                    });
                    if (!res.ok) {
                        throw new Error(
                            `HTTP ${res.status} - ${await res.text()}`
                        );
                    }
                    const data = await res.json();
                    const text = (
                        data[expectField] ||
                        data.result ||
                        ''
                    ).toString();
                    setEditorText(text.trim());
                } catch (e) {
                    alert('불러오기 실패: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('btn-rewrite').onclick = doRewrite;
                document.getElementById('btn-summary').onclick = doSummary;
                document.getElementById('btn-expand').onclick = doExpand;
                document.getElementById('btn-style').onclick = doStyle;
                document.getElementById('btn-honorific').onclick = doHonorific;
                document.getElementById('btn-informal').onclick = doInformal;
                document.getElementById('btn-translate').onclick = doTranslate;
                document.getElementById('btn-grammar').onclick = doGrammar;
                document.getElementById('pdfDownloadBtn').onclick = saveAsPDF;
                document.getElementById('btn-ocr')?.addEventListener('click', doOCRorFile);

            });
        </script>

        <!-- Preloader -->
        <div id="preloader"></div>

        <!-- Vendor JS Files -->
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/vendor/php-email-form/validate.js"></script>
        <script src="assets/vendor/aos/aos.js"></script>
        <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
        <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
        <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
        <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

        <script src="assets/js/script.js"></script>
        <script src="assets/js/main.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
        <script>
(function () {
  /* ========== 공통 유틸 ========== */
  const ready = (fn) => (document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', fn)
    : fn());

  function _pickText(x){
  if (!x) return '';
  if (typeof x === 'string') return x;
  if (Array.isArray(x)) return x.map(_pickText).filter(Boolean).join('\n');
  if (typeof x === 'object'){
    // 우선순위 키들
    const keys = ['text','ocr','ocr_text','content','payload','output','message','result','data','response','lines'];
    for (const k of keys){
      if (k in x){
        const s = _pickText(x[k]);
        if (s) return s;
      }
    }
    // 아무 키도 못 찾으면 모든 필드를 순회
    for (const v of Object.values(x)){
      const s = _pickText(v);
      if (s) return s;
    }
  }
  return '';
}

  /* 0) 레이아웃: 헤더 높이를 CSS 변수로 */
  function setHeaderH() {
    const h = (document.getElementById('header') || {}).offsetHeight || 64;
    document.documentElement.style.setProperty('--header-h', h + 'px');
  }
  window.addEventListener('load', setHeaderH);
  window.addEventListener('resize', setHeaderH);
  setHeaderH();

  /* 1) 내보내기: PDF 저장 (전역) */
  window.saveAsPDF = async function () {
    if (!window.quill) return alert('에디터가 아직 준비되지 않았어요.');
    const content = quill.root;
    html2pdf()
      .set({
        margin: 10,
        filename: 'Editor PDF.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      })
      .from(content)
      .save();
  };

  /* 2) 툴바: 이미지 버튼 → 메뉴 토글 */
  ready(function () {
    const btn  = document.getElementById('btn-image');
    const menu = document.getElementById('imgMenu');
    if (!btn || !menu) return;

    const onKey = (e) => { if (e.key === 'Escape') close(); };
    const onDoc = (e) => { if (!menu.contains(e.target) && e.target !== btn) close(); };

    function open() {
      const r = btn.getBoundingClientRect();
      menu.style.top  = (r.bottom + window.scrollY + 6) + 'px';
      menu.style.left = (r.left   + window.scrollX) + 'px';
      menu.setAttribute('aria-hidden', 'false');
      setTimeout(() => document.addEventListener('click', onDoc, { once: true }), 0);
      window.addEventListener('keydown', onKey);
    }
    function close() {
      menu.setAttribute('aria-hidden', 'true');
      window.removeEventListener('keydown', onKey);
    }

    btn.addEventListener('click', function (e) {
      e.preventDefault();
      (menu.getAttribute('aria-hidden') !== 'false') ? open() : close();
    });
  });

  const OCR = {
  image: { url: '/visionOCR',   method: 'POST', field: 'image' }, // 예: '/api/vision/ocr'
  pdf:   { url: '/fileScan',    method: 'POST', field: 'file'  }, // 예: '/api/ocr/pdf'
  base:  (window.BASE_URL || window.API_BASE_URL || '')           // ''면 현재 도메인
};

// 안전한 URL 결합
function joinUrl(base, path){
  if (!base) return path;
  return (base.endsWith('/') ? base.slice(0,-1) : base) + (path.startsWith('/') ? '' : '/') + path;
}
  // DOM을 매번 다시 가져오기 (초기 로드 타이밍 이슈 방지)
  function _ocrRefs(){
    return {
      modal:   document.getElementById('ocrModal'),
      txtArea: document.getElementById('ocrText'),
      btnIns:  document.getElementById('ocrInsert'),
      btnClose:document.getElementById('ocrClose'),
      fileIn:  document.getElementById('ocrFile')
    };
  }

  function openModal(text){
  const { modal, txtArea } = _ocrRefs();
  if (!modal || !txtArea) return;
  txtArea.value = (text || '').toString();
  modal.setAttribute('aria-hidden','false');

  // ▼ 추가: 모달 열릴 때 상단 메뉴바 숨김 + 이미지 메뉴 닫기
  document.documentElement.classList.add('is-ocr-open');
  const imgMenu = document.getElementById('imgMenu');
  if (imgMenu) imgMenu.setAttribute('aria-hidden','true');

  setTimeout(()=>txtArea.focus(), 0);
}

function closeModal(){
  const { modal } = _ocrRefs();
  if (modal) modal.setAttribute('aria-hidden','true');

  // ▼ 추가: 모달 닫힐 때 메뉴바 복구
  document.documentElement.classList.remove('is-ocr-open');
}


  // (선택) 스피너 유틸
  function spin(on){
    const ov = document.getElementById('edit_spinner');
    if (ov){
      ov.setAttribute('aria-hidden', String(!on));
      document.documentElement.classList.toggle('is-edit-loading', !!on);
    }
  }

  // 메뉴 클릭 직전에 커서 위치 저장 (선택한 위치에 삽입하기 위함)
  let __insertRange = null;
  document.addEventListener('mousedown', (e)=>{
    if (e.target.closest('#imgMenu-ocr') && window.quill){
      __insertRange = quill.getSelection(true);
    }
  });

  // ESC 로 닫기
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModal(); });

  // ✅ 단일 위임 핸들러: 닫기 / 삽입 / 이미지 추출
  document.addEventListener('click', async (e)=>{

    if (e.target.closest('#ocrClose')) {
    e.preventDefault();
    closeModal();
    return;
  }

      if (e.target.closest('#ocrInsert')) {
    e.preventDefault();
    if (!window.quill) return;
    const { txtArea } = _ocrRefs();
    const q = window.quill;
    const text  = (txtArea?.value || '').toString();
    const range = __insertRange || q.getSelection(true) || { index: q.getLength(), length: 0 };
    q.insertText(range.index, text, 'user');
    q.setSelection(range.index + text.length, 0, 'silent');
    __insertRange = null;
    closeModal();
    return;
  }

// ③ 이미지 추출
if (e.target.closest('#imgMenu-ocr')) {
  const { fileIn, txtArea } = _ocrRefs();
  const file = fileIn?.files?.[0];
  if (!file){ openModal('먼저 파일을 선택해 주세요.'); return; }

  openModal('추출 중… 잠시만요.');
  if (txtArea) txtArea.disabled = true;
  spin(true);

  try {
    const isPDF = /\.pdf$/i.test(file.name);
    const EP = isPDF ? OCR.pdf : OCR.image;           // 엔드포인트 선택
    const url = joinUrl(OCR.base, EP.url);

    let out = '';

    // 서버 시도
    try {
      const fd = new FormData();
      fd.append(EP.field, file);
      const init = { method: EP.method };
      if (EP.method.toUpperCase() === 'POST') init.body = fd;

      const res = await fetch(url, init);
      const ct  = (res.headers.get('content-type') || '').toLowerCase();

      if (!res.ok) throw Object.assign(new Error('HTTP '+res.status), {status:res.status, ct});
      if (ct.includes('application/json')) {
        const j = await res.json();
        console.log('OCR response:', j);
        out = (typeof _pickText === 'function' ? _pickText(j) : '') || JSON.stringify(j, null, 2);
      } else {
        out = await res.text();
      }

    } catch (srvErr) {
      // 405(메서드 불가)·404(경로 없음)·CORS/네트워크 실패 → 이미지면 브라우저 OCR 폴백
      const status = srvErr?.status || 0;
      const methodProblem = status === 405 || status === 404;
      if (!isPDF && (methodProblem || !navigator.onLine || status === 0) && window.Tesseract) {
        console.warn('Server OCR failed, fallback to Tesseract.js:', srvErr);
        const { data } = await Tesseract.recognize(file, 'kor+eng'); // 언어는 필요에 맞게
        out = (data && data.text) ? data.text : '';
      } else {
        throw srvErr; // PDF이거나 폴백 불가면 상위 catch로
      }
    }

    const refs = _ocrRefs();
    if (refs.txtArea) refs.txtArea.value = (out || '').toString().trim();

  } catch (err) {
    const refs = _ocrRefs();
    if (refs.txtArea) refs.txtArea.value = '';
    alert('이미지 추출 실패: ' + (err?.message || err));
  } finally {
    const refs = _ocrRefs();
    if (refs.txtArea) refs.txtArea.disabled = false;
    spin(false);
  }
}

  });

  // (옵션) 외부에서 강제로 열고 싶을 때
  document.addEventListener('editor:open-ocr', ()=>{
    const fake = document.getElementById('imgMenu-ocr');
    if (fake) fake.click();
    else openModal('파일을 선택하고 “이미지 추출”을 누르세요.');
  });

})();
</script>


        <!-- Editor overlay spinner -->
<div id="edit_spinner" class="edit_spinner" aria-hidden="true">
  <div class="edit_spinner__backdrop"></div>
  <div class="edit_spinner__center" role="status" aria-live="polite" aria-label="처리 중">
    <div class="edit_spinner__ring"></div>
    <div class="edit_spinner__label">처리 중…</div>
  </div>
</div>
<div id="imgMenu" class="img-menu" aria-hidden="true" role="menu" aria-labelledby="btn-image">
  <div class="img-menu__title">다음에서 그림 삽입:</div>
  <button type="button" id="imgMenu-insert" class="img-menu__item" role="menuitem">
    <i class="bi bi-image"></i> 이미지 삽입
  </button>
  <button type="button" id="imgMenu-ocr" class="img-menu__item" role="menuitem">
    <i class="bi bi-file-earmark-text"></i> 이미지 추출
  </button>
</div>
<!-- OCR 결과 팝업 -->
<div id="ocrModal" class="ocr-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="ocr-modal__dialog">
    <div class="ocr-modal__header">
      <strong>이미지 텍스트 추출</strong>
      <button type="button" id="ocrClose" class="ocr-modal__close" aria-label="닫기">✕</button>
    </div>
    <div class="ocr-modal__body">
      <textarea id="ocrText" class="ocr-modal__textarea" placeholder="여기에 추출된 텍스트가 표시됩니다…"></textarea>
    </div>
    <div class="modal-actions">
  <button id="ocrInsert" type="button" class="insert-btn">삽입</button>
</div>

  </div>
</div>


    </body>
</html>
