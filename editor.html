<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <title>StoryCraft Editor</title>
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <meta name="description" content="" />
        <meta name="keywords" content="" />

        <!-- Favicons -->
        <link href="assets/img/favicon.png" rel="icon" />
        <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

        <!-- Fonts -->
        <link href="https://fonts.googleapis.com" rel="preconnect" />
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Nunito:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
            rel="stylesheet"
        />

        <!-- Vendor CSS Files -->
        <link
            href="assets/vendor/bootstrap/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
            rel="stylesheet"
        />
        <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
        <link
            href="assets/vendor/glightbox/css/glightbox.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/swiper/swiper-bundle.min.css"
            rel="stylesheet"
        />
        <!-- Quill -->
        <link
            href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css"
            rel="stylesheet"
        />

        <!-- Main CSS File -->
        <link href="assets/css/main.css" rel="stylesheet" />
  
    </head>
    <body class="index-page page-editor">
        <header id="header" class="header d-flex align-items-center sticky-top">
            <div
                class="container position-relative d-flex align-items-center justify-content-between"
            >
                <a
                    href="index.html"
                    class="logo d-flex align-items-center me-auto me-xl-0"
                >
                    <!-- Uncomment the line below if you also wish to use an image logo -->
                    <!-- <img src="assets/img/logo.png" alt=""> -->
                    <h1 class="sitename">StoryCraft</h1>
                </a>

                <nav id="navmenu" class="navmenu">
                    <ul>
                        <!-- <li>
                            <a href="index.html#hero" class="active">Home</a>
                        </li>
                        <li><a href="index.html#about">About</a></li>
                        <li><a href="index.html#services">Services</a></li> -->
                        <li><a href="search.html">Search</a></li>
                        <li><a href="rewrite.html">Rewrite</a></li>
                        <li><a href="change-style.html">Style</a></li>
                        <li><a href="grammar.html">Grammar</a></li>
                        <li><a href="honorific.html">Honorific</a></li>
                        <li><a href="translate.html">Translate</a></li>
                        <li><a href="scan.html">Scan</a></li>
                        <li><a href="image.html">Image Scan</a></li>
                        <li><a href="speech.html">Speech</a></li>
                        <li><a href="editor.html" class="active">Editor</a></li>
                    </ul>
                    <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
                </nav>
            </div>
        </header>
        
        <div class="wrap">
        <!-- ì—ë””í„° ì¹´ë“œ -->
            <div class="card editor-card">
                <div class="ql-frame">
                <div class="toolbar">
                    <div id="quill-toolbar">
                        <span class="ql-formats">
                            <select class="ql-header">
                                <option value="1"></option>
                                <option value="2"></option>
                                <option selected></option>
                            </select>
                            <select class="ql-font">
  <option value="malgun" selected></option>
  <option value="serif"></option>
  <option value="monospace"></option>
  <option value="batang"></option>
  <option value="gungsuh"></option>
  <option value="gulim"></option>
  <option value="noto-sans-kr"></option>
</select>

                            <select class="ql-size"></select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                            <button class="ql-strike"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                            <select class="ql-align"></select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-link"></button>
                            <button class="ql-blockquote"></button>
                            <button class="ql-code-block"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-clean"></button>

                             <button type="button" id="btn-image" class="btn-image" title="ì´ë¯¸ì§€">
                                <i class="bi bi-image"></i>
                            </button>
                        </span>

                        <span class="ql-formats edit-upload">
  <input id="ocrFile" type="file" accept="image/*,application/pdf" hidden>
  <label for="ocrFile" class="edit-upload__btn" title="íŒŒì¼ ì—…ë¡œë“œ" aria-label="íŒŒì¼ ì—…ë¡œë“œ">
    <i class="bi bi-folder-fill"></i><span class="edit-upload__text">íŒŒì¼ ì—…ë¡œë“œ</span>
  </label>
  <span id="ocrFileName" class="edit-upload__name" hidden></span>
</span>
                    </div>
                </div>
                <div id="quill" class="editor"></div>
                </div>
                
               

                <textarea id="userInput" style="display: none"></textarea>
                <input id="styleInput" type="hidden" />
                <input id="translateInput" type="hidden" />
            </div>

            <!-- ì‚¬ì´ë“œ íˆ´ íŒ¨ë„ -->
            <div class="card side">
                <section class="panel">
                    <div class="panel-title">Translate & Import</div>
                    <div class="grid-2" style="margin-bottom: 8px">
                        <select
                            id="sourceSelector"
                            class="sc-select"
                            title="ì›ë³¸ ì–¸ì–´"
                        >
                            <option value="auto" selected>ìë™ ê°ì§€</option>
                            <option value="gu">êµ¬ìë¼íŠ¸ì–´</option>
                            <option value="el">ê·¸ë¦¬ìŠ¤ì–´</option>
                            <option value="ne">ë„¤íŒ”ì–´</option>
                            <option value="nl">ë„¤ëœë€ë“œì–´</option>
                            <option value="de">ë…ì¼ì–´</option>
                            <option value="ru">ëŸ¬ì‹œì•„ì–´</option>
                            <option value="ro">ë£¨ë§ˆë‹ˆì•„ì–´</option>
                            <option value="mr">ë§ˆë¼í‹°ì–´</option>
                            <option value="ms">ë§ë ˆì´ì–´</option>
                            <option value="vi">ë² íŠ¸ë‚¨ì–´</option>
                            <option value="bn">ë²µê³¨ì–´</option>
                            <option value="sv">ìŠ¤ì›¨ë´ì–´</option>
                            <option value="es">ìŠ¤í˜ì¸ì–´</option>
                            <option value="af">ì•„í”„ë¦¬ì¹¸ìŠ¤ì–´</option>
                            <option value="ar">ì•„ëì–´</option>
                            <option value="en">ì˜ì–´</option>
                            <option value="uk">ìš°í¬ë¼ì´ë‚˜ì–´</option>
                            <option value="it">ì´íƒˆë¦¬ì•„ì–´</option>
                            <option value="ja">ì¼ë³¸ì–´</option>
                            <option value="jv">ìë°”ì–´</option>
                            <option value="ka">ì¡°ì§€ì•„ì–´</option>
                            <option value="zh-CN">ì¤‘êµ­ì–´(ê°„ì²´)</option>
                            <option value="zh-TW">ì¤‘êµ­ì–´(ë²ˆì²´)</option>
                            <option value="ta">íƒ€ë°€ì–´</option>
                            <option value="th">íƒœêµ­ì–´</option>
                            <option value="tr">í„°í‚¤ì–´</option>
                            <option value="fa">í˜ë¥´ì‹œì•„ì–´</option>
                            <option value="pt">í¬ë¥´íˆ¬ê°ˆì–´</option>
                            <option value="pl">í´ë€ë“œì–´</option>
                            <option value="fr">í”„ë‘ìŠ¤ì–´</option>
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="hi">íŒë””ì–´</option>
                        </select>

                        <!-- ëŒ€ìƒ ì–¸ì–´ ì„ íƒ -->
                        <select
                            id="targetSelector"
                            class="sc-select"
                            title="ëŒ€ìƒ ì–¸ì–´"
                        >
                            <option value="gu">êµ¬ìë¼íŠ¸ì–´</option>
                            <option value="el">ê·¸ë¦¬ìŠ¤ì–´</option>
                            <option value="ne">ë„¤íŒ”ì–´</option>
                            <option value="nl">ë„¤ëœë€ë“œì–´</option>
                            <option value="de">ë…ì¼ì–´</option>
                            <option value="ru">ëŸ¬ì‹œì•„ì–´</option>
                            <option value="ro">ë£¨ë§ˆë‹ˆì•„ì–´</option>
                            <option value="mr">ë§ˆë¼í‹°ì–´</option>
                            <option value="ms">ë§ë ˆì´ì–´</option>
                            <option value="vi">ë² íŠ¸ë‚¨ì–´</option>
                            <option value="bn">ë²µê³¨ì–´</option>
                            <option value="sv">ìŠ¤ì›¨ë´ì–´</option>
                            <option value="es">ìŠ¤í˜ì¸ì–´</option>
                            <option value="af">ì•„í”„ë¦¬ì¹¸ìŠ¤ì–´</option>
                            <option value="ar">ì•„ëì–´</option>
                            <option value="en" selected>ì˜ì–´</option>
                            <option value="uk">ìš°í¬ë¼ì´ë‚˜ì–´</option>
                            <option value="it">ì´íƒˆë¦¬ì•„ì–´</option>
                            <option value="ja">ì¼ë³¸ì–´</option>
                            <option value="jv">ìë°”ì–´</option>
                            <option value="ka">ì¡°ì§€ì•„ì–´</option>
                            <option value="zh-CN">ì¤‘êµ­ì–´(ê°„ì²´)</option>
                            <option value="zh-TW">ì¤‘êµ­ì–´(ë²ˆì²´)</option>
                            <option value="ta">íƒ€ë°€ì–´</option>
                            <option value="th">íƒœêµ­ì–´</option>
                            <option value="tr">í„°í‚¤ì–´</option>
                            <option value="fa">í˜ë¥´ì‹œì•„ì–´</option>
                            <option value="pt">í¬ë¥´íˆ¬ê°ˆì–´</option>
                            <option value="pl">í´ë€ë“œì–´</option>
                            <option value="fr">í”„ë‘ìŠ¤ì–´</option>
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="hi">íŒë””ì–´</option>
                        </select>
                    </div>

                    <div class="grid-1">
                        <button
                            class="sc-btn sc-btn--primary"
                            id="btn-translate"
                        >
                            ğŸŒ ë²ˆì—­
                        </button>
                    </div>
                </section>

                <div class="hr"></div>

                <!-- ë¬¸ì²´ë³€ê²½ -->
                <section class="panel">
                    <div class="panel-title">Style & Tone</div>
                    <div class="grid-2" style="margin-bottom: 8px">
                        <select
                            id="styleSelector"
                            class="sc-select"
                            title="ë¬¸ì²´ ì„ íƒ"
                        >
                            <option value="casual">êµ¬ì–´ì²´</option>
                            <option value="formal">ê²©ì‹ì²´</option>
                            <option value="literary">ë¬¸í•™ì²´</option>
                            <option value="academic">í•™ìˆ ì²´</option>
                        </select>
                        <button
                            class="sc-btn sc-btn--primary"
                            id="btn-style"
                            onclick="applyStyle()"
                        >
                            âœ’ï¸ ë¬¸ì²´ë³€ê²½
                        </button>
                    </div>

                    <div class="grid-2">
                        <button class="sc-btn sc-btn--honorific" id="btn-honorific">ğŸ™‡ ë†’ì„ë§</button>

                        <button class="sc-btn sc-btn--informal" id="btn-informal">
                            ğŸ™‚ ë°˜ë§
                        </button>
                    </div>
                </section>

                <div class="hr"></div>

                <!-- ì²¨ì‚­/ìš”ì•½/í™•ì¥ -->
                <section class="panel">
                    <div class="panel-title">Rewrite & Summary</div>
                    <div class="grid-2" style="margin-bottom: 8px">
                        <button
                            class="sc-btn sc-btn--summary"
                            id="btn-summary"
                        >
                            ğŸ§¾ ìš”ì•½
                        </button>

                        <button class="sc-btn sc-btn--expand" id="btn-expand">â• í™•ì¥</button>
                        
                    </div>
                    <div class="grid-1">
                        <button class="sc-btn sc-btn--primary"
                     id="btn-rewrite">ğŸ› ï¸ ì²¨ì‚­</button>

                    </div>
                </section>
                <!-- ë¬¸ë²• êµì • -->
                <section class="panel">
                    <div class="panel-title">Grammar</div>
                    <div class="grid-1">
                        <button
                            class="sc-btn sc-btn--primary"
                            id="btn-grammar"
                        >
                            âœ”ï¸ ë¬¸ë²• êµì •
                        </button>
                    </div>
                </section>

                <section class="panel sticky">
                    <div class="panel-title">Export</div>
                    <div class="grid-1">
                        <button
                            class="sc-btn sc-btn--secondary"
                            id="pdfDownloadBtn"
                        >
                            â¬‡ï¸ PDFë¡œ ì €ì¥
                        </button>
                    </div>
                </section>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
        <script>
  (function(){
    const input = document.getElementById('ocrFile');
    const nameEl = document.getElementById('ocrFileName');
    if (!input || !nameEl) return;
    input.addEventListener('change', function(){
      const file = this.files && this.files[0];
      if (file){
        nameEl.textContent = file.name;
        nameEl.hidden = false;
      }else{
        nameEl.textContent = '';
        nameEl.hidden = true;

    
      }
    });
  })();
</script>

        <script>
           
            const PROD_API = 'https://storycraft-ppxj.onrender.com'; 
            const LOCAL_API = 'http://127.0.0.1:8000'; 

            const isLocalHost =
            location.hostname === 'localhost' ||
            location.hostname.startsWith('127.') ||
            location.hostname.endsWith('.local');

            const BASE_URL = isLocalHost ? LOCAL_API : PROD_API;
            window.BASE_URL = BASE_URL;
            window.API_BASE_URL = BASE_URL;
            const $editSpinner = document.getElementById('edit_spinner');

            const Font = Quill.import('formats/font');
            Font.whitelist = [
            'malgun','batang','gungsuh','gulim','noto-sans-kr', 'sans-serif','serif','monospace'
            ];

            const SizeStyle = Quill.import('attributors/style/size');
            SizeStyle.whitelist = [
  '13.3px', // 10pt
  '14.7px', // 11pt
  '16px',   // 12pt
  '18.7px', // 14pt
  '21.3px', // 16pt
  '24px',   // 18pt
  '32px'    // 24pt
];
            Quill.register(SizeStyle, true);
            Quill.register(Font, true);

            function injectSizePresetBeforeInit(){
                const sel = document.querySelector('#quill-toolbar .ql-size');
                if (!sel) return;
                sel.id = 'sizePreset';
                if (!sel.options.length) {
                    sel.innerHTML = `
  <option value="13.3px">10</option>
  <option value="14.7px">11</option>
  <option value="16px"   selected>12</option>
  <option value="18.7px">14</option>
  <option value="21.3px">16</option>
  <option value="24px">18</option>
  <option value="32px">24</option>
`;

    }
        }

            injectSizePresetBeforeInit();

            

            const quill = new Quill('#quill', {
                modules: { toolbar: '#quill-toolbar' },
                theme: 'snow',
                placeholder: 'ì—¬ê¸°ì— ë¬¸ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”â€¦',
            });
             window.quill = quill;
            
const toolbarMod = quill.getModule('toolbar');

let __sizeRange = null;
const toolbarEl = document.getElementById('quill-toolbar');
const captureRange = () => { __sizeRange = quill.getSelection(true); };
toolbarEl?.querySelector('.ql-picker.ql-size')?.addEventListener('mousedown', captureRange);
document.getElementById('sizePreset')?.addEventListener('mousedown', captureRange);
toolbarEl?.querySelector('.ql-picker.ql-size')?.addEventListener('touchstart', captureRange, {passive:true});

toolbarMod.addHandler('size', (value) => {
  // valueê°€ ì´ì œ '16px' ê°™ì€ px ë¬¸ìì—´
  if (!value) { quill.format('size', false); return; }

  const range = __sizeRange || quill.getSelection();
  if (range && range.length > 0) {
    quill.formatText(range.index, range.length, 'size', value, 'user');
    quill.setSelection(range.index, range.length, 'silent');
  } else {
    quill.format('size', value);
  }
  __sizeRange = null;
});

            quill.setSelection(0, 0, 'silent');
            quill.format('font', 'malgun', 'silent');

            const fontSel = document.querySelector('.ql-font');
            if (fontSel) fontSel.value = 'malgun';

            
            function setEditorText(text) {
                
                quill.setText(text || '');
            }
            function getEditorText() {
                return quill.getText(); 
            }

            
            function showSpin(v) {
                
                document.documentElement.classList.toggle('is-edit-loading', !!v);

                const el = document.getElementById('edit_spinner');
                if (el) el.setAttribute('aria-hidden', String(!v));
    }


function getQuillSelectionOrAll() {

  const sel = quill.getSelection(true);
  if (sel && sel.length > 0) {
    const text = quill.getText(sel.index, sel.length);
    return {
      text,
      isAll: false,
      apply(out) {
        const attrs = quill.getFormat(sel.index, Math.max(sel.length, 1));
        quill.deleteText(sel.index, sel.length, 'user');
        quill.insertText(sel.index, out, attrs, 'user');
        quill.setSelection(sel.index + out.length, 0, 'silent');
      },
    };
  }

  const len = quill.getLength();
  const text = quill.getText(0, len);
  return {
    text,
    isAll: true,
    apply(out) { quill.setText(out); },
  };
}


['btn-rewrite','btn-summary','btn-expand','btn-style','btn-honorific','btn-informal','btn-translate','btn-grammar']
  .forEach(id=>{
    const b=document.getElementById(id);
    if(!b) return;
    b.addEventListener('mousedown', ()=>{ window.__lastQuillRange = quill.getSelection(true); });
  });
quill.on('selection-change', (range)=>{ window.__lastQuillRange = range; });


            async function postJSON(url, payload) {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(`HTTP ${res.status} - ${t}`);
                }
                return res.json();
            }

           
            async function doRewrite() {
  const { text, apply } = getQuillSelectionOrAll();
  const content = (text || '').trim();
  if (!content) { alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  showSpin(true);
  try {
    const data = await postJSON(`${BASE_URL}/mistralRewrite`, { content });
    const out =
      (data?.result ?? data?.text ?? data?.styled_text ?? data?.checked ?? data?.translated ?? '').trim();
    if (!out) throw new Error('ë¹ˆ ê²°ê³¼');
    
    apply(out);
  } catch (e) {
    alert('ì²¨ì‚­ ì‹¤íŒ¨: ' + e.message);
  } finally {
    showSpin(false);
  }
}

            async function doSummary() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/summary`, {
                        content,
                    }); 
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('ë¹ˆ ê²°ê³¼');
                    apply(out);
                } catch (e) {
                    alert('ìš”ì•½ ì‹¤íŒ¨: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doExpand() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/expand`, {
                        content,
                    }); // í™•ì¥ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('ë¹ˆ ê²°ê³¼');
                    apply(out);
                } catch (e) {
                    alert('í™•ì¥ ì‹¤íŒ¨: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doStyle() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                const style = document.getElementById('styleSelector').value;

                if (!content) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                showSpin(true);

                try {
                    const data = await postJSON(`${BASE_URL}/gptStyleChange`, {
                        text: content,
                        style: style,
                    }); 
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('ë¹ˆ ê²°ê³¼');
                    apply(out);
                } catch (e) {
                    alert('ë¬¸ì²´ë³€ê²½ ì‹¤íŒ¨: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doHonorific() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/cohereHonorific`, {
                        content,
                    });
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('ë¹ˆ ê²°ê³¼');
                    apply(out);
                } catch (e) {
                    alert('ë†’ì„ë§ ë³€í™˜ ì‹¤íŒ¨: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doInformal() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/cohereInformal`, {
                        content,
                    });
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('ë¹ˆ ê²°ê³¼');
                    apply(out);
                } catch (e) {
                    alert('ë°˜ë§ ë³€í™˜ ì‹¤íŒ¨: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doTranslate() {
                const { text, apply } = getQuillSelectionOrAll();
                const content = (text || '').trim();
                if (!content) {
                    alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                showSpin(true);
                try {
                    const data = await postJSON(`${BASE_URL}/translate`, {
                        text: content,
                        source: 'auto',
                        target: 'en',
                    });
                    const out = (data?.result ?? data?.text ?? data?.checked ?? data?.styled_text ?? data?.translated ?? '').trim();
    if (!out) throw new Error('ë¹ˆ ê²°ê³¼');
                    apply(out);
                } catch (e) {
                    alert('ë²ˆì—­ ì‹¤íŒ¨: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            async function doOCRorFile() {
                
                const file = document.getElementById('ocrFile').files[0];
                if (!file) {
                    alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                    return;
                }

                const form = new FormData();
                
                if (/\.(png|jpg|jpeg|bmp|tif|tiff)$/i.test(file.name)) {
                    form.append('image', file);
                    await uploadTo(`${BASE_URL}/visionOCR`, form, 'text');
                } else {
                    form.append('file', file);
                    await uploadTo(`${BASE_URL}/fileScan`, form, 'text');
                }
            }
            async function doGrammar() {
  const { text, apply } = getQuillSelectionOrAll();
  const content = (text || '').trim();
  if (!content) { alert('ì„ íƒ(ë˜ëŠ” ì „ì²´) ë‚´ìš©ì´ ë¹„ì–´ ìˆì–´ìš”.'); return; }

  showSpin(true);
  try {
    const data = await postJSON(`${BASE_URL}/editorGrammar`, { content });
  
    const out = (data?.checked ?? data?.result ?? data?.text ?? '').trim();
    if (!out) throw new Error('ë¹ˆ ê²°ê³¼');


    apply(out);
  } catch (e) {
    alert('ë¬¸ë²• êµì • ì‹¤íŒ¨: ' + e.message);
  } finally {
    showSpin(false);
  }
}
            async function uploadTo(url, form, expectField = 'text') {
                showSpin(true);
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        body: form,
                    });
                    if (!res.ok) {
                        throw new Error(
                            `HTTP ${res.status} - ${await res.text()}`
                        );
                    }
                    const data = await res.json();
                    const text = (
                        data[expectField] ||
                        data.result ||
                        ''
                    ).toString();
                    setEditorText(text.trim());
                } catch (e) {
                    alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message);
                } finally {
                    showSpin(false);
                }
            }

            
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('btn-rewrite').onclick = doRewrite;
                document.getElementById('btn-summary').onclick = doSummary;
                document.getElementById('btn-expand').onclick = doExpand;
                document.getElementById('btn-style').onclick = doStyle;
                document.getElementById('btn-honorific').onclick = doHonorific;
                document.getElementById('btn-informal').onclick = doInformal;
                document.getElementById('btn-translate').onclick = doTranslate;
                document.getElementById('btn-grammar').onclick = doGrammar;
                document.getElementById('pdfDownloadBtn').onclick = saveAsPDF;
                document.getElementById('btn-ocr')?.addEventListener('click', doOCRorFile);

            });
        </script>

        <!-- Preloader -->
        <div id="preloader"></div>

        <!-- Vendor JS Files -->
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/vendor/php-email-form/validate.js"></script>
        <script src="assets/vendor/aos/aos.js"></script>
        <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
        <script src="assets/vendor/imagesloaded/imagesloaded.pkgd.min.js"></script>
        <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
        <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

        <script src="assets/js/script.js"></script>
        <script src="assets/js/main.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
        <script>
(function () {
  /* ========== ê³µí†µ ìœ í‹¸ ========== */
  const ready = (fn) => (document.readyState === 'loading'
    ? document.addEventListener('DOMContentLoaded', fn)
    : fn());

  function _pickText(x){
  if (!x) return '';
  if (typeof x === 'string') return x;
  if (Array.isArray(x)) return x.map(_pickText).filter(Boolean).join('\n');
  if (typeof x === 'object'){
    // ìš°ì„ ìˆœìœ„ í‚¤ë“¤
    const keys = ['text','ocr','ocr_text','content','payload','output','message','result','data','response','lines'];
    for (const k of keys){
      if (k in x){
        const s = _pickText(x[k]);
        if (s) return s;
      }
    }
    // ì•„ë¬´ í‚¤ë„ ëª» ì°¾ìœ¼ë©´ ëª¨ë“  í•„ë“œë¥¼ ìˆœíšŒ
    for (const v of Object.values(x)){
      const s = _pickText(v);
      if (s) return s;
    }
  }
  return '';
}

  /* 0) ë ˆì´ì•„ì›ƒ: í—¤ë” ë†’ì´ë¥¼ CSS ë³€ìˆ˜ë¡œ */
  function setHeaderH() {
    const h = (document.getElementById('header') || {}).offsetHeight || 64;
    document.documentElement.style.setProperty('--header-h', h + 'px');
  }
  window.addEventListener('load', setHeaderH);
  window.addEventListener('resize', setHeaderH);
  setHeaderH();

  /* 1) ë‚´ë³´ë‚´ê¸°: PDF ì €ì¥ (ì „ì—­) */
  window.saveAsPDF = async function () {
    if (!window.quill) return alert('ì—ë””í„°ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”.');
    const content = quill.root;
    html2pdf()
      .set({
        margin: 10,
        filename: 'Editor PDF.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      })
      .from(content)
      .save();
  };

  /* 2) íˆ´ë°”: ì´ë¯¸ì§€ ë²„íŠ¼ â†’ ë©”ë‰´ í† ê¸€ */
  ready(function () {
    const btn  = document.getElementById('btn-image');
    const menu = document.getElementById('imgMenu');
    if (!btn || !menu) return;

    const onKey = (e) => { if (e.key === 'Escape') close(); };
    const onDoc = (e) => { if (!menu.contains(e.target) && e.target !== btn) close(); };

    function open() {
      const r = btn.getBoundingClientRect();
      menu.style.top  = (r.bottom + window.scrollY + 6) + 'px';
      menu.style.left = (r.left   + window.scrollX) + 'px';
      menu.setAttribute('aria-hidden', 'false');
      setTimeout(() => document.addEventListener('click', onDoc, { once: true }), 0);
      window.addEventListener('keydown', onKey);
    }
    function close() {
      menu.setAttribute('aria-hidden', 'true');
      window.removeEventListener('keydown', onKey);
    }

    btn.addEventListener('click', function (e) {
      e.preventDefault();
      (menu.getAttribute('aria-hidden') !== 'false') ? open() : close();
    });
  });

  const OCR = {
  image: { url: '/visionOCR',   method: 'POST', field: 'image' }, // ì˜ˆ: '/api/vision/ocr'
  pdf:   { url: '/fileScan',    method: 'POST', field: 'file'  }, // ì˜ˆ: '/api/ocr/pdf'
  base:  (window.BASE_URL || window.API_BASE_URL || '')           // ''ë©´ í˜„ì¬ ë„ë©”ì¸
};

// ì•ˆì „í•œ URL ê²°í•©
function joinUrl(base, path){
  if (!base) return path;
  return (base.endsWith('/') ? base.slice(0,-1) : base) + (path.startsWith('/') ? '' : '/') + path;
}
  // DOMì„ ë§¤ë²ˆ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° (ì´ˆê¸° ë¡œë“œ íƒ€ì´ë° ì´ìŠˆ ë°©ì§€)
  function _ocrRefs(){
    return {
      modal:   document.getElementById('ocrModal'),
      txtArea: document.getElementById('ocrText'),
      btnIns:  document.getElementById('ocrInsert'),
      btnClose:document.getElementById('ocrClose'),
      fileIn:  document.getElementById('ocrFile')
    };
  }

  function openModal(text){
  const { modal, txtArea } = _ocrRefs();
  if (!modal || !txtArea) return;
  txtArea.value = (text || '').toString();
  modal.setAttribute('aria-hidden','false');

  // â–¼ ì¶”ê°€: ëª¨ë‹¬ ì—´ë¦´ ë•Œ ìƒë‹¨ ë©”ë‰´ë°” ìˆ¨ê¹€ + ì´ë¯¸ì§€ ë©”ë‰´ ë‹«ê¸°
  document.documentElement.classList.add('is-ocr-open');
  const imgMenu = document.getElementById('imgMenu');
  if (imgMenu) imgMenu.setAttribute('aria-hidden','true');

  setTimeout(()=>txtArea.focus(), 0);
}

function closeModal(){
  const { modal } = _ocrRefs();
  if (modal) modal.setAttribute('aria-hidden','true');

  // â–¼ ì¶”ê°€: ëª¨ë‹¬ ë‹«í ë•Œ ë©”ë‰´ë°” ë³µêµ¬
  document.documentElement.classList.remove('is-ocr-open');
}


  // (ì„ íƒ) ìŠ¤í”¼ë„ˆ ìœ í‹¸
  function spin(on){
    const ov = document.getElementById('edit_spinner');
    if (ov){
      ov.setAttribute('aria-hidden', String(!on));
      document.documentElement.classList.toggle('is-edit-loading', !!on);
    }
  }

  // ë©”ë‰´ í´ë¦­ ì§ì „ì— ì»¤ì„œ ìœ„ì¹˜ ì €ì¥ (ì„ íƒí•œ ìœ„ì¹˜ì— ì‚½ì…í•˜ê¸° ìœ„í•¨)
  let __insertRange = null;
  document.addEventListener('mousedown', (e)=>{
    if (e.target.closest('#imgMenu-ocr') && window.quill){
      __insertRange = quill.getSelection(true);
    }
  });

  // ESC ë¡œ ë‹«ê¸°
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModal(); });

  // âœ… ë‹¨ì¼ ìœ„ì„ í•¸ë“¤ëŸ¬: ë‹«ê¸° / ì‚½ì… / ì´ë¯¸ì§€ ì¶”ì¶œ
  document.addEventListener('click', async (e)=>{

    if (e.target.closest('#ocrClose')) {
    e.preventDefault();
    closeModal();
    return;
  }

      if (e.target.closest('#ocrInsert')) {
    e.preventDefault();
    if (!window.quill) return;
    const { txtArea } = _ocrRefs();
    const q = window.quill;
    const text  = (txtArea?.value || '').toString();
    const range = __insertRange || q.getSelection(true) || { index: q.getLength(), length: 0 };
    q.insertText(range.index, text, 'user');
    q.setSelection(range.index + text.length, 0, 'silent');
    __insertRange = null;
    closeModal();
    return;
  }

// â‘¢ ì´ë¯¸ì§€ ì¶”ì¶œ
if (e.target.closest('#imgMenu-ocr')) {
  const { fileIn, txtArea } = _ocrRefs();
  const file = fileIn?.files?.[0];
  if (!file){ openModal('ë¨¼ì € íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

  openModal('ì¶”ì¶œ ì¤‘â€¦ ì ì‹œë§Œìš”.');
  if (txtArea) txtArea.disabled = true;
  spin(true);

  try {
    const isPDF = /\.pdf$/i.test(file.name);
    const EP = isPDF ? OCR.pdf : OCR.image;           // ì—”ë“œí¬ì¸íŠ¸ ì„ íƒ
    const url = joinUrl(OCR.base, EP.url);

    let out = '';

    // ì„œë²„ ì‹œë„
    try {
      const fd = new FormData();
      fd.append(EP.field, file);
      const init = { method: EP.method };
      if (EP.method.toUpperCase() === 'POST') init.body = fd;

      const res = await fetch(url, init);
      const ct  = (res.headers.get('content-type') || '').toLowerCase();

      if (!res.ok) throw Object.assign(new Error('HTTP '+res.status), {status:res.status, ct});
      if (ct.includes('application/json')) {
        const j = await res.json();
        console.log('OCR response:', j);
        out = (typeof _pickText === 'function' ? _pickText(j) : '') || JSON.stringify(j, null, 2);
      } else {
        out = await res.text();
      }

    } catch (srvErr) {
      // 405(ë©”ì„œë“œ ë¶ˆê°€)Â·404(ê²½ë¡œ ì—†ìŒ)Â·CORS/ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨ â†’ ì´ë¯¸ì§€ë©´ ë¸Œë¼ìš°ì € OCR í´ë°±
      const status = srvErr?.status || 0;
      const methodProblem = status === 405 || status === 404;
      if (!isPDF && (methodProblem || !navigator.onLine || status === 0) && window.Tesseract) {
        console.warn('Server OCR failed, fallback to Tesseract.js:', srvErr);
        const { data } = await Tesseract.recognize(file, 'kor+eng'); // ì–¸ì–´ëŠ” í•„ìš”ì— ë§ê²Œ
        out = (data && data.text) ? data.text : '';
      } else {
        throw srvErr; // PDFì´ê±°ë‚˜ í´ë°± ë¶ˆê°€ë©´ ìƒìœ„ catchë¡œ
      }
    }

    const refs = _ocrRefs();
    if (refs.txtArea) refs.txtArea.value = (out || '').toString().trim();

  } catch (err) {
    const refs = _ocrRefs();
    if (refs.txtArea) refs.txtArea.value = '';
    alert('ì´ë¯¸ì§€ ì¶”ì¶œ ì‹¤íŒ¨: ' + (err?.message || err));
  } finally {
    const refs = _ocrRefs();
    if (refs.txtArea) refs.txtArea.disabled = false;
    spin(false);
  }
}

  });

  // (ì˜µì…˜) ì™¸ë¶€ì—ì„œ ê°•ì œë¡œ ì—´ê³  ì‹¶ì„ ë•Œ
  document.addEventListener('editor:open-ocr', ()=>{
    const fake = document.getElementById('imgMenu-ocr');
    if (fake) fake.click();
    else openModal('íŒŒì¼ì„ ì„ íƒí•˜ê³  â€œì´ë¯¸ì§€ ì¶”ì¶œâ€ì„ ëˆ„ë¥´ì„¸ìš”.');
  });

})();
</script>


        <!-- Editor overlay spinner -->
<div id="edit_spinner" class="edit_spinner" aria-hidden="true">
  <div class="edit_spinner__backdrop"></div>
  <div class="edit_spinner__center" role="status" aria-live="polite" aria-label="ì²˜ë¦¬ ì¤‘">
    <div class="edit_spinner__ring"></div>
    <div class="edit_spinner__label">ì²˜ë¦¬ ì¤‘â€¦</div>
  </div>
</div>
<div id="imgMenu" class="img-menu" aria-hidden="true" role="menu" aria-labelledby="btn-image">
  <div class="img-menu__title">ë‹¤ìŒì—ì„œ ê·¸ë¦¼ ì‚½ì…:</div>
  <button type="button" id="imgMenu-insert" class="img-menu__item" role="menuitem">
    <i class="bi bi-image"></i> ì´ë¯¸ì§€ ì‚½ì…
  </button>
  <button type="button" id="imgMenu-ocr" class="img-menu__item" role="menuitem">
    <i class="bi bi-file-earmark-text"></i> ì´ë¯¸ì§€ ì¶”ì¶œ
  </button>
</div>
<!-- OCR ê²°ê³¼ íŒì—… -->
<div id="ocrModal" class="ocr-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="ocr-modal__dialog">
    <div class="ocr-modal__header">
      <strong>ì´ë¯¸ì§€ í…ìŠ¤íŠ¸ ì¶”ì¶œ</strong>
      <button type="button" id="ocrClose" class="ocr-modal__close" aria-label="ë‹«ê¸°">âœ•</button>
    </div>
    <div class="ocr-modal__body">
      <textarea id="ocrText" class="ocr-modal__textarea" placeholder="ì—¬ê¸°ì— ì¶”ì¶œëœ í…ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤â€¦"></textarea>
    </div>
    <div class="modal-actions">
  <button id="ocrInsert" type="button" class="insert-btn">ì‚½ì…</button>
</div>

  </div>
</div>


    </body>
</html>
